---
import Layout from "../layouts/Layout.astro";
import imageConnexion from "../assets/image-connexion.png";
---

<Layout title="TaVue - Inscription">
    <div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-5xl">
            <div class="grid lg:grid-cols-2 gap-8 items-stretch">
                <!-- Colonne gauche - Image -->
                <div class="hidden lg:block">
                    <div class="h-full rounded-lg overflow-hidden shadow-lg">
                        <img
                            src={imageConnexion.src}
                            alt="Atelier TaVue - Élégance à la française"
                            class="w-full h-full object-cover"
                        />
                    </div>
                </div>

                <!-- Colonne droite - Formulaire -->
                <div class="flex items-center">
                    <div class="bg-white rounded-lg shadow-lg p-8 w-full">
                        <!-- En-tête -->
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-900 mb-3">
                                Créer un compte
                            </h1>
                            <p class="text-gray-600">
                                Rejoignez la communauté TaVue
                            </p>
                        </div>

                        <!-- Message d'erreur/succès -->
                        <div id="message" class="hidden mb-4 p-4 rounded-lg"></div>

                        <!-- Formulaire -->
                        <form id="inscription-form" class="space-y-5">
                            <!-- Nom -->
                            <div class="form-control">
                                <label class="label pb-1">
                                    <span class="label-text font-semibold text-gray-900">Nom complet</span>
                                </label>
                                <input
                                    type="text"
                                    id="name"
                                    placeholder="Jean Dupont"
                                    class="input w-full bg-white border-gray-300 placeholder:text-gray-400 text-black"
                                    required
                                />
                            </div>

                            <!-- Email -->
                            <div class="form-control">
                                <label class="label pb-1">
                                    <span class="label-text font-semibold text-gray-900">Email</span>
                                </label>
                                <input
                                    type="email"
                                    id="email"
                                    placeholder="vous@exemple.com"
                                    class="input w-full bg-white border-gray-300 placeholder:text-gray-400 text-black"
                                    required
                                />
                            </div>

                            <!-- Mot de passe -->
                            <div class="form-control">
                                <label class="label pb-1">
                                    <span class="label-text font-semibold text-gray-900">Mot de passe</span>
                                </label>
                                <input
                                    type="password"
                                    id="password"
                                    placeholder="••••••••"
                                    class="input w-full bg-white border-gray-300 placeholder:text-gray-400 text-black"
                                    required
                                    minlength="8"
                                />
                                <p class="text-xs text-gray-500 mt-1">Minimum 8 caractères</p>
                            </div>

                            <!-- Confirmation mot de passe -->
                            <div class="form-control">
                                <label class="label pb-1">
                                    <span class="label-text font-semibold text-gray-900">Confirmer le mot de passe</span>
                                </label>
                                <input
                                    type="password"
                                    id="passwordConfirm"
                                    placeholder="••••••••"
                                    class="input w-full bg-white border-gray-300 placeholder:text-gray-400 text-black"
                                    required
                                    minlength="8"
                                />
                            </div>

                            <!-- Conditions d'utilisation -->
                            <div class="flex items-start gap-2 pt-2">
                                <input
                                    type="checkbox"
                                    id="terms"
                                    class="checkbox checkbox-sm mt-1"
                                    required
                                />
                                <label for="terms" class="text-sm text-gray-700">
                                    J'accepte les <a href="/conditions" class="text-cyan-500 hover:text-cyan-600">conditions d'utilisation</a> et la <a href="/confidentialite" class="text-cyan-500 hover:text-cyan-600">politique de confidentialité</a>
                                </label>
                            </div>

                            <!-- Bouton d'inscription -->
                            <div class="form-control pt-2">
                                <button
                                    type="submit"
                                    class="btn bg-cyan-500 hover:bg-cyan-600 border-none w-full text-white"
                                >
                                    Créer mon compte
                                </button>
                            </div>

                            <!-- Séparateur -->
                            <div class="divider text-sm text-gray-500 my-6">ou</div>

                            <!-- Lien connexion -->
                            <div class="text-center">
                                <p class="text-gray-700">
                                    Vous avez déjà un compte? 
                                    <a href="/connexion" class="text-cyan-500 hover:text-cyan-600 font-medium">
                                        Se connecter
                                    </a>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    /* Checkbox avec icône noire quand cochée */
    .checkbox:checked {
        background-color: #000000;
        border-color: #000000;
    }
</style>

<script>
    import pb from '../utils/pb.js';

    const form = document.getElementById('inscription-form') as HTMLFormElement;
    const messageDiv = document.getElementById('message') as HTMLDivElement;

    function showMessage(message: string, isError: boolean = false) {
        messageDiv.textContent = message;
        messageDiv.className = `mb-4 p-4 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        messageDiv.classList.remove('hidden');
    }

    function hideMessage() {
        messageDiv.classList.add('hidden');
    }

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();

            const name = (document.getElementById('name') as HTMLInputElement).value;
            const email = (document.getElementById('email') as HTMLInputElement).value;
            const password = (document.getElementById('password') as HTMLInputElement).value;
            const passwordConfirm = (document.getElementById('passwordConfirm') as HTMLInputElement).value;
            const terms = (document.getElementById('terms') as HTMLInputElement).checked;

            // Validation
            if (password !== passwordConfirm) {
                showMessage('Les mots de passe ne correspondent pas', true);
                return;
            }

            if (!terms) {
                showMessage('Vous devez accepter les conditions d\'utilisation', true);
                return;
            }

            try {
                // Créer l'utilisateur avec PocketBase
                const user = await pb.collection('users').create({
                    name: name,
                    email: email,
                    password: password,
                    passwordConfirm: passwordConfirm,
                    emailVisibility: true
                });

                console.log('Utilisateur créé:', user);
                
                showMessage('✅ Compte créé avec succès ! Redirection...', false);
                
                // Rediriger vers la page de connexion après 2 secondes
                setTimeout(() => {
                    window.location.href = '/connexion';
                }, 2000);
            } catch (error: any) {
                console.error('Erreur lors de la création:', error);
                
                // Gérer les erreurs spécifiques
                if (error.response?.data?.email) {
                    showMessage('Cet email est déjà utilisé', true);
                } else if (error.response?.data?.password) {
                    showMessage('Le mot de passe doit contenir au moins 8 caractères', true);
                } else {
                    showMessage('Erreur lors de la création du compte: ' + (error.message || 'Erreur inconnue'), true);
                }
            }
        });
    }
</script>
